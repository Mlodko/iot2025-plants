<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>IoT Roślinki - Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

 <!-- CSS -->
    <link href="static/css/main.css" rel="stylesheet" />
    <link href="static/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/css/animate.min.css" rel="stylesheet" />
    <link href="static/css/paper-dashboard.css" rel="stylesheet" />
  <!-- Fonts & icons -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP"
    crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
  <link href="static/css/themify-icons.css" rel="stylesheet">
    <!--jquery-->
    <script src="static/js/jquery.min.js" type="text/javascript"></script>

  <style>
    .device-dropdown {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 14px;
      color: #444;
      margin-left: 10px;
    }

    .device-dropdown:focus {
      outline: none;
      border-color: #8b7d6b;
      box-shadow: 0 0 3px rgba(139, 125, 107, 0.3);
    }
    .row-eq-height {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  flex-wrap: wrap;
}

  /* To sprawia, że kolumny stają się kontenerami flex */
  .row-eq-height > [class*='col-'] {
    display: flex;
    flex-direction: column;
  }
  
  /* To sprawia, że karta rozciąga się na całą dostępną wysokość kolumny */
  .row-eq-height > [class*='col-'] .card {
    flex: 1;
    width: 100%; /* Dla pewności */
  }
  
  /* Wyjątek dla prawej kolumny (tam gdzie są dwie karty) */
  /* Dzięki temu odstęp między nimi będzie zachowany */
  .row-eq-height > [class*='col-'] .card + .card {
      margin-top: 20px; /* Dodatkowy odstęp jeśli karty się skleją */
  }
  </style>
</head>

<body>
  <div class="wrapper">

    <!-- Sidebar -->
    <div class="sidebar" data-background-color="white" data-active-color="warning">
      <div class="sidebar-wrapper">
        <div class="logo">
        <a href="/devices" class="simple-text" style="display:flex; align-items:center; justify-content:center; gap:8px;">
             <i class="fas fa-seedling" style="color:#2eff00; font-size:20px;"></i>
                 IoT&nbsp;Roślinki
            </a>
        </div>

        <ul class="nav">
          <li >
            <a href="/devices">
              <i class="fas fa-leaf"></i>
              <p>Devices</p>
            </a>
          </li>
          <li class="active">
            <a href="/">
              <i class="fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li>
            <a href="/graph">
              <i class="ti-pie-chart"></i>
              <p>Graphs</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="main-panel">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar bar1"></span>
              <span class="icon-bar bar2"></span>
              <span class="icon-bar bar3"></span>
            </button>

            <a class="navbar-brand" href="#">Dashboard</a>
            <div class="navbar-brand dashboard-title">
              <select id="deviceSelect" class="device-dropdown"></select>
            </div>
          </div>
        </div>
      </nav>

      <!-- Content -->
      <div class="content">
        <div class="container-fluid">

          <!-- Sensor Cards -->
          <div class="row">
            <div class="col-lg-4 col-sm-6">
              <div class="card">
                <div class="content">
                  <div class="row">
                    <div class="col-xs-4">
                      <div class="icon-big icon-danger text-center">
                        <i class="fas fa-temperature-high"></i>
                      </div>
                    </div>
                    <div class="col-xs-8">
                      <div class="numbers">
                        <p>Temperature</p>
                        <span id="tempValue"></span>&#176;C
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-sm-6">
              <div class="card">
                <div class="content">
                  <div class="row">
                    <div class="col-xs-3">
                      <div class="icon-big icon-info text-center">
                        <i class="fas fa-tint"></i>
                      </div>
                    </div>
                    <div class="col-xs-9">
                      <div class="numbers">
                        <p>Humidity</p>
                        <span id="humValue"></span>%
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-sm-6">
              <div class="card">
                <div class="content">
                  <div class="row">
                    <div class="col-xs-3">
                      <div class="icon-big icon-success text-center">
                        <i class="fas fa-seedling"></i>
                      </div>
                    </div>
                    <div class="col-xs-9">
                      <div class="numbers">
                        <p>Soil Moisture</p>
                        <span id="soilValue">%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Brightness Level -->
          <div class="row">
            <div class="col-lg-4 col-sm-6">
              <div class="card">
                <div class="content">
                  <div class="row">
                    <div class="col-xs-3">
                      <div class="icon-big icon-warning text-center">
                        <i class="fas fa-lightbulb"></i>
                      </div>
                    </div>
                    <div class="col-xs-9">
                      <div class="numbers">
                        <p>Brightness Level</p>
                        <span id="lightValue"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Automated Watering & Lighting -->
          <div class="row row-eq-height">
            <!-- Watering -->
              <div class="col-md-4">
                  <div class="card">
                      <div class="header">
                          <h4 class="title">Automated Watering</h4>
                      </div>
                      <div class="content text-center">
                          <label class="toggleBtn">
                              <input class="switch-input" id="autoSwitch" type="checkbox" onclick="auto()"/>
                              <span class="switch-label" data-on="on" data-off="off"></span>
                              <span class="switch-handle"></span>
                          </label>

                          <div class="form-group mt-3">
                              <label for="wateringThreshold">
                                  <i class="fas fa-tint" style="color: #66615b;"></i> Watering Mode:
                              </label>

                              <select id="wateringThreshold" class="form-control text-center"
                                      style="text-align-last: center;"
                                      onchange="saveThreshold('watering', this.value)">
                                  <option value="500">Mild (Dry)</option>

                                  <option value="700" selected>Medium (Normal)</option>

                                  <option value="1000">Max (Wet)</option>
                              </select>

                            <div style="margin-top: 15px; font-size: 12px; color: #9a9a9a; line-height: 1.5;">
                                <p style="margin-bottom: 5px; font-size: 12px;">
                                    <i class="ti-info-alt"></i>
                                    The system will automatically water the plant when <b>soil moisture</b> drops below:
                                </p>
                                <div style="font-weight: 600; color: #66615b; background-color: #f9f9f9; padding: 4px; border-radius: 4px; border: 1px solid #eee;">
                                    Mild: ~500 &nbsp;|&nbsp; Medium: ~700 &nbsp;|&nbsp; Max: ~1000
                                </div>
                            </div>
                          </div>

                      </div>
                  </div>
              </div>
<div class="col-md-4">
                  <div class="card">
                      <div class="header">
                          <h4 class="title">Manual Watering</h4>
                      </div>
                      <div class="content text-center">

                          <div style="margin-bottom: 15px; margin-top: 10px;">
                              <i class="fas fa-hand-holding-water" style="font-size: 32px; color: #7ac29a;"></i>
                          </div>

                          <div class="form-group">
                              <label style="font-size: 14px;">Volume:
                                  <span id="manualAmountDisplay"
                                        style="font-weight:bold; font-size:16px; color: #EB5E28;">14</span> ml
                              </label>

                              <input type="range" id="manualAmountSlider"
                                     min="14" max="140" step="14" value="14"
                                     style="width: 100%; cursor: pointer; margin-top: 5px;"
                                     oninput="updateSliderLabel(this.value)">

                              <div style="display:flex; justify-content:space-between; font-size:10px; color:#9a9a9a;">
                                  <span>14ml</span>
                                  <span>140ml</span>
                              </div>
                          </div>

                          <button class="btn btn-info btn-fill btn-wd" style="margin-top: 15px;"
                                  onclick="triggerManualWater()">
                              <i class="fas fa-shower"></i> Water Now
                          </button>

                      </div>
                  </div>
              </div>

            <!-- Lighting -->
              <div class="col-md-4">
                  <div class="card">
                      <div class="header">
                          <h4 class="title">Manual Lighting</h4>
                      </div>
                      <div class="content text-center">

                          <div class="form-group">
                              <label class="toggleBtn">
                                  <input class="switch-input" id="lightSwitch" type="checkbox" onclick="toggleLight()"/>
                                  <span class="switch-label" data-on="ON" data-off="OFF"></span>
                                  <span class="switch-handle"></span>
                              </label>
                          </div>

                          <p class="category" style="font-size: 12px; margin-top: 10px; color: #9a9a9a;">
                              Control the grow light manually
                          </p>

                      </div>
                  </div>
              </div>
            <div class="col-md-4">
              <div class="card">
                <div class="header">
                  <h4 class="title">Automated Lighting</h4>
                </div>
                <div class="content text-center">
                  <label class="toggleBtn">
                    <input class="switch-input" id="manualSwitch" type="checkbox" onclick="manual()" />
                    <span class="switch-label" data-on="on" data-off="off"></span>
                    <span class="switch-handle"></span>
                  </label>

                  <div class="form-group mt-3">
                    <label for="lightingThreshold">Threshold:</label>
                    <input type="number" id="lightingThreshold" class="form-control text-center"
                           placeholder="Enter threshold" min="0" max="100"
                           onchange="saveThreshold('lighting', this.value)" />
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
<script>
    // 1) Pobieramy device_id z dropdowna
    function getSelectedDeviceId() {
        var sel = document.getElementById('deviceSelect');
        if (!sel || !sel.value) {
            alert("Najpierw wybierz urządzenie z listy Device.");
            return null;
        }
        return parseInt(sel.value);
    }

    // 2) Wspólna funkcja do wysyłania komend
    function sendCommand(commandName, payload) {
        var deviceId = getSelectedDeviceId();
        if (deviceId === null || isNaN(deviceId)) {
            return;
        }

        fetch("/api/commands", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                device_id: deviceId,
                command: commandName,
                payload_json: payload || null
            })
        })
        .then(function (resp) {
            if (!resp.ok) {
                throw new Error("HTTP " + resp.status);
            }
            return resp.json();
        })
        .then(function (data) {
            console.log("[CMD OK]", data);
        })
        .catch(function (err) {
            console.error("[CMD ERROR]", err);
            alert("Nie udało się wysłać komendy: " + err);
        });
    }

    // === MANUAL WATERING ===
    function updateSliderLabel(val) {
        document.getElementById('manualAmountDisplay').innerText = val;
    }

    function triggerManualWater() {
        var amount = parseInt(document.getElementById('manualAmountSlider').value, 10);
        if (isNaN(amount) || amount <= 0) {
            alert("Nieprawidłowa ilość wody.");
            return;
        }

        // TU JEST schema DurationScheduledTime
        var payload = {
            mode: "manual",
            amount_ml: amount,
            scheduled_time: {
                // minimalnie wymagane wg schemy: start_time
                start_time: "now"
                // jeśli chcesz, możesz potem dodać:
                // duration: "PT30S",        // 30 sekund
                // repeat_interval: "PT1H"   // co godzinę
            }
        };

        sendCommand("manual_watering", payload);

        console.log("Wysyłam komendę podlania: " + amount + " ml");
        alert("Podlewam roślinkę dawką: " + amount + " ml!");
    }

    // === MANUAL LIGHTING ===
    function toggleLight() {
        var isChecked = document.getElementById('lightSwitch').checked;
        var state = isChecked ? "on" : "off";

        console.log("Light turned " + state.toUpperCase());

        var payload = {
            mode: "manual",
            state: state,
            scheduled_time: {
                start_time: "now"
                // np. jeśli chcesz wymusić świecenie np. godzinę:
                // duration: "PT1H"
            }
        };

        sendCommand("manual_light", payload);
    }
</script>



  <script src="static/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="static/js/bootstrap-checkbox-radio.js"></script>
  <script src="static/js/chartist.min.js"></script>
  <script src="static/js/paper-dashboard.js"></script>
  <script src="static/js/main.js" type="text/javascript"></script>

</body>
</html>

