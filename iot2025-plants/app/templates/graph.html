<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>IoT Roślinki - Graph</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS -->
  <link href="/static/css/main.css" rel="stylesheet" />
  <link href="/static/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/static/css/animate.min.css" rel="stylesheet" />
  <link href="/static/css/paper-dashboard.css" rel="stylesheet" />
  <!-- (opcjonalnie) Chartist CSS dla ładniejszych osi/labeli -->
  <link href="/static/css/chartist.min.css" rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" crossorigin="anonymous">
  <link href="/static/css/themify-icons.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="/static/js/jquery.min.js"></script>

  <style>
    .sidebar .logo { text-align:center; font-weight:700; font-size:18px; padding:25px 0 15px; border-bottom:1px solid #eee; }
    .sidebar .logo a { color:#5a5449; text-decoration:none; }
    .sidebar ul.nav li.active i, .sidebar ul.nav li.active p { color:#F3BB45; }
    .main-panel { margin-left:220px; padding:30px; }
    .card { background:#fff; border-radius:6px; margin-bottom:30px; padding:20px; }
    .card .header h4 { color:#5a5449; }
    .card .header p { color:#888; margin-bottom:15px; }
    .ct-chart { height: 300px; }
    .ct-label.ct-horizontal.ct-end {
        transform: rotate(-45deg);
        transform-origin: 100% 50%;
        white-space: nowrap;
    }
.filter-btns {
  margin-top: 10px;
}
.filter-btns .btn {
  margin-right: 5px;
  transition: all 0.2s;
}
.filter-btns .btn.active {
  color: white !important;
}
    .device-dropdown {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 14px;
      color: #444;
      margin-left: 10px;
    }

    .device-dropdown:focus {
      outline: none;
      border-color: #8b7d6b;
      box-shadow: 0 0 3px rgba(139, 125, 107, 0.3);
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" data-background-color="white" data-active-color="warning">
    <div class="sidebar-wrapper">
      <div class="logo">
        <a href="/devices_ui" class="simple-text" style="display:flex;align-items:center;justify-content:center;gap:8px;">
          <i class="fas fa-seedling" style="color:#2eff00; font-size:20px;"></i>
          IoT&nbsp;Roślinki
        </a>
      </div>
      <ul class="nav">
        <li><a href="/devices_ui"><i class="fas fa-leaf"></i><p>Devices</p></a></li>
        <li><a href="/"><i class="fas fa-tachometer-alt"></i><p>Dashboard</p></a></li>
        <li class="active"><a href="/graph_ui"><i class="ti-pie-chart"></i><p>Graphs</p></a></li>
      </ul>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="main-panel">
    <nav class="navbar navbar-default" style="margin-bottom:20px">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar bar1"></span>
            <span class="icon-bar bar2"></span>
            <span class="icon-bar bar3"></span>
          </button>
          <a class="navbar-brand" href="#">Graph</a>
          <div class="navbar-brand dashboard-title">
              <select id="deviceSelect" class="device-dropdown">
                  <option value="12345">Plant 1</option>
              </select>
            </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">

        <div class="row">

            <!-- TEMPERATURA -->
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Temperature</h4>
                        <p class="category">Realtime temperature reading</p>
                        <div class="filter-btns" data-chart="tempChart">
                            <button class="btn btn-sm btn-outline-warning" data-hours="4">4h</button>
                            <button class="btn btn-sm btn-outline-warning" data-hours="12">12h</button>
                            <button class="btn btn-sm btn-outline-warning active" data-hours="24">24h</button>
                            <button class="btn btn-sm btn-outline-warning" data-hours="168">7d</button>
                        </div>
                    </div>
                    <div class="content">
                        <div id="tempChart" class="ct-chart ct-major-twelfth"></div>
                    </div>
                </div>
            </div>

            <!-- WILGOTNOŚĆ -->
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Humidity</h4>
                        <p class="category">Realtime humidity reading</p>
                        <div class="filter-btns" data-chart="humChart">
                            <button class="btn btn-sm btn-outline-info" data-hours="4">4h</button>
                            <button class="btn btn-sm btn-outline-info" data-hours="12">12h</button>
                            <button class="btn btn-sm btn-outline-info active" data-hours="24">24h</button>
                            <button class="btn btn-sm btn-outline-info" data-hours="168">7d</button>
                        </div>
                    </div>
                    <div class="content">
                        <div id="humChart" class="ct-chart ct-major-twelfth"></div>
                    </div>
                </div>
            </div>

            <!-- WILGOTNOŚĆ GLEBY -->
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Soil Moisture Level</h4>
                        <p class="category">Realtime soil moisture reading</p>
                        <div class="filter-btns" data-chart="soilChart">
                            <button class="btn btn-sm btn-outline-success" data-hours="4">4h</button>
                            <button class="btn btn-sm btn-outline-success" data-hours="12">12h</button>
                            <button class="btn btn-sm btn-outline-success active" data-hours="24">24h</button>
                            <button class="btn btn-sm btn-outline-success" data-hours="168">7d</button>
                        </div>
                    </div>
                    <div class="content">
                        <div id="soilChart" class="ct-chart ct-major-twelfth"></div>
                    </div>
                </div>
            </div>

            <!-- ŚWIATŁO -->
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Light Level</h4>
                        <p class="category">Realtime light level reading</p>
                        <div class="filter-btns" data-chart="lightChart">
                            <button class="btn btn-sm btn-outline-primary" data-hours="4">4h</button>
                            <button class="btn btn-sm btn-outline-primary" data-hours="12">12h</button>
                            <button class="btn btn-sm btn-outline-primary active" data-hours="24">24h</button>
                            <button class="btn btn-sm btn-outline-primary" data-hours="168">7d</button>
                        </div>
                    </div>
                    <div class="content">
                        <div id="lightChart" class="ct-chart ct-major-twelfth"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/chartist.min.js"></script>
  <script src="/static/js/paper-dashboard.js"></script>
  <script src="/static/js/bootstrap-checkbox-radio.js"></script>

  <!-- App JS -->
  <script>
      // --- USTAWIENIA ---
      const REFRESH_MS = 10000;       // co ile ms odświeżać
      const MAX_POINTS = 500;         // maks. ilość punktów na wykres

      // heurystyki do dopasowania typu sensora -> wykres
      const matchers = {
          temperature: (t) => /temp|dht.*temp|temperature/i.test(t),
          humidity: (t) => /hum|dht.*hum|humidity/i.test(t),
          soil: (t) => /soil|moist/i.test(t),
          light: (t) => /light|ldr|lux/i.test(t),
      };

      // pomocnicze funkcje czasu
      function isoHoursAgo(h) {
          const d = new Date(Date.now() - h * 3600 * 1000);
          return d.toISOString();
      }

      function toLocalTimeStr(iso) {
          return new Date(iso).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      }

      // rysowanie wykresu Chartist
      function drawLine(chartSelector, values, labels) {
          const data = {labels, series: [values]};
          const options = {
              fullWidth: true,
              chartPadding: {right: 20},
              axisY: {onlyInteger: false},
              showPoint: false,
              axisX: {
                  labelInterpolationFnc: function (value, index) {
                      return index % Math.ceil(labels.length / 6) === 0 ? value : null;
                  }
              }
          };
          new Chartist.Line(chartSelector, data, options);
      }

      // pobiera odczyty sensora
      async function fetchReadings(sensorId, hours) {
          const since = isoHoursAgo(hours);
          const url = `/api/readings?sensor_id=${sensorId}&since=${encodeURIComponent(since)}&page_size=${MAX_POINTS}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("GET " + url + " -> " + res.status);
          return res.json();
      }

      // wybiera sensory po typach
      async function pickSensors() {
          const res = await fetch(`/api/sensors?page_size=500`);
          if (!res.ok) throw new Error("GET /api/sensors -> " + res.status);
          const sensors = await res.json();

          const out = {temperature: null, humidity: null, soil: null, light: null};
          for (const s of sensors) {
              const t = s.type || "";
              if (!out.temperature && matchers.temperature(t)) out.temperature = s.id;
              else if (!out.humidity && matchers.humidity(t)) out.humidity = s.id;
              else if (!out.soil && matchers.soil(t)) out.soil = s.id;
              else if (!out.light && matchers.light(t)) out.light = s.id;
          }
          return out;
      }

      // rysuje pojedynczy wykres z danym zakresem czasu
      async function renderSingle(chartId, hours, sensors) {
          try {
              const sensorMap = {
                  tempChart: sensors.temperature,
                  humChart: sensors.humidity,
                  soilChart: sensors.soil,
                  lightChart: sensors.light
              };
              const sensorId = sensorMap[chartId];
              if (!sensorId) return;

              const rows = await fetchReadings(sensorId, hours);
              const values = rows.map(r => r.value).reverse();
              const labels = rows.map(r => toLocalTimeStr(r.ts)).reverse();
              drawLine(`#${chartId}`, values, labels);
          } catch (e) {
              console.error("renderSingle error", e);
          }
      }

      // rysuje wszystkie wykresy (używane przy starcie)
      async function renderAll(defaultHours = 24) {
          const sensors = await pickSensors();
          const charts = ["tempChart", "humChart", "soilChart", "lightChart"];
          for (const id of charts) {
              await renderSingle(id, defaultHours, sensors);
          }
      }

      // Połączenie WebSocket (domyślnie ws://, jeśli https to wss://)
      const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${wsProtocol}://${location.host}/ws`);

      ws.onopen = () => console.log("[WS] Connected");
      ws.onclose = () => console.log("[WS] Disconnected");

      ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log("[WS] Update:", data);

          const {sensor_type, value, ts} = data;
          const label = new Date(ts).toLocaleTimeString();

          // Aktualizuj wykresy na żywo
          if (sensor_type.includes("temp")) {
              appendData("#tempChart", value, label);
          } else if (sensor_type.includes("hum")) {
              appendData("#humChart", value, label);
          } else if (sensor_type.includes("soil")) {
              appendData("#soilChart", value, label);
          } else if (sensor_type.includes("light")) {
              appendData("#lightChart", value, label);
          }
      };

      // Bufory danych dla każdego wykresu
      const chartData = {
          "#tempChart": {values: [], labels: []},
          "#humChart": {values: [], labels: []},
          "#soilChart": {values: [], labels: []},
          "#lightChart": {values: [], labels: []},
      };

      // Funkcja pomocnicza do aktualizacji wykresu Chartist
      function appendData(selector, value, label) {
          const d = chartData[selector];
          if (!d) return;
          d.values.push(value);
          d.labels.push(label);
          if (d.values.length > 100) { // ogranicz liczbę punktów
              d.values.shift();
              d.labels.shift();
          }
          if (d.chart) {
              d.chart.update({labels: d.labels, series: [d.values]});
          } else {
              d.chart = new Chartist.Line(selector, {labels: d.labels, series: [d.values]}, {showPoint: false});
          }
      }

      // --- URUCHOMIENIE ---
      document.addEventListener('DOMContentLoaded', async () => {
          const sensors = await pickSensors(); // zrób jedno zapytanie o sensory

          // dla każdego zestawu przycisków
          document.querySelectorAll('.filter-btns').forEach(group => {
              const chartId = group.dataset.chart;

              group.querySelectorAll('button').forEach(btn => {
                  btn.addEventListener('click', async e => {
                      const hours = parseInt(btn.dataset.hours);

                      // zmiana aktywnego przycisku
                      group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                      btn.classList.add('active');

                      // render tylko tego wykresu
                      await renderSingle(chartId, hours, sensors);
                  });
              });
          });

          // początkowe rysowanie
          await renderAll();

          // auto-refresh co REFRESH_MS dla aktualnych zakresów
          setInterval(async () => {
              const activeButtons = document.querySelectorAll('.filter-btns button.active');
              for (const btn of activeButtons) {
                  const parent = btn.closest('.filter-btns');
                  const chartId = parent.dataset.chart;
                  const hours = parseInt(btn.dataset.hours);
                  await renderSingle(chartId, hours, sensors);
              }
          }, REFRESH_MS);
      });
  </script>
  <!-- <script>
  document.addEventListener("DOMContentLoaded", () => {
    function drawChart(containerSelector, labels, values) {
      new Chartist.Line(containerSelector, {
        labels: labels,
        series: [values]
      }, {
        fullWidth: true,
        chartPadding: { right: 20 },
        axisY: { onlyInteger: false }
      });
    }

    function loadAndRender() {
      fetch("/api/graphs/latest?points=60")
        .then(r => r.json())
        .then(data => {
          const t = data.temperature || {labels:[], values:[]};
          const h = data.humidity    || {labels:[], values:[]};
          const s = data.soil        || {labels:[], values:[]};
          const l = data.light       || {labels:[], values:[]};

          drawChart("#tempChart",  t.labels, t.values);
          drawChart("#humChart",   h.labels, h.values);
          drawChart("#soilChart",  s.labels, s.values);
          drawChart("#lightChart", l.labels, l.values);
        })
        .catch(err => console.error("graphs/latest error", err));
    }

    loadAndRender();
    // auto-refresh co 10s
    setInterval(loadAndRender, 10000);
  });
  </script>
-->
</body>
</html>

